{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "logicAppName": {
      "type": "string",
      "defaultValue": "SOCRadar-Sentinel-Webhook-LA",
      "metadata": {
        "description": "The name of the Logic App to create."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The location for the Logic App."
      }
    },
    "sentinelWorkspaceName": {
      "type": "string",
      "metadata": {
        "description": "Name of your Sentinel workspace"
      }
    },
    "sentinelResourceGroup": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "Resource group containing Sentinel workspace"
      }
    }
  },
  "variables": {
    "azureSentinelConnectionName": "azuresentinel-webhook-1",
    "azureSentinelConnectionResourceId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('location'), '/managedApis/azuresentinel')]",
    "azureSentinelWorkspacePath": "[concat('/Incidents/subscriptions/', subscription().subscriptionId, '/resourceGroups/', parameters('sentinelResourceGroup'), '/workspaces/', parameters('sentinelWorkspaceName'))]",
    "workflowDefinition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "triggers": {
        "manual": {
          "type": "Http",
          "inputs": {
            "schema": {
              "properties": {
                "data": {
                  "items": {
                    "properties": {
                      "alarm_asset": {
                        "type": ["string", "null"]
                      },
                      "alarm_assignees": {
                        "type": ["array", "null"]
                      },
                      "alarm_id": {
                        "type": ["integer", "null"]
                      },
                      "alarm_related_assets": {
                        "type": ["array", "null"]
                      },
                      "alarm_related_entities": {
                        "items": {
                          "properties": {
                            "key": {
                              "type": ["string", "null"]
                            },
                            "value": {
                              "type": ["string", "null"]
                            }
                          },
                          "type": ["object", "null"]
                        },
                        "type": ["array", "null"]
                      },
                      "alarm_response": {
                        "type": ["string", "null"]
                      },
                      "alarm_risk_level": {
                        "type": ["string", "null"]
                      },
                      "alarm_text": {
                        "type": ["string", "null"]
                      },
                      "alarm_type_details": {
                        "properties": {
                          "alarm_generic_title": {
                            "type": ["string", "null"]
                          }
                        },
                        "type": ["object", "null"]
                      },
                      "approved_by": {
                        "type": ["object", "string", "null"]
                      },
                      "content": {
                        "type": ["object", "null"]
                      },
                      "date": {
                        "type": ["string", "null"]
                      },
                      "extra": {
                        "type": ["array", "null"]
                      },
                      "history": {
                        "type": ["array", "null"]
                      },
                      "is_approved": {
                        "type": ["boolean", "null"]
                      },
                      "last_notification_date": {
                        "type": ["string", "null"]
                      },
                      "notes": {
                        "type": ["array", "null"]
                      },
                      "notification_id": {
                        "type": ["integer", "null"]
                      },
                      "status": {
                        "type": ["string", "null"]
                      },
                      "tags": {
                        "type": ["array", "null"]
                      }
                    },
                    "type": ["object", "null"]
                  },
                  "type": ["array", "null"]
                },
                "is_success": {
                  "type": ["boolean", "null"]
                },
                "message": {
                  "type": ["string", "null"]
                },
                "response_code": {
                  "type": ["integer", "null"]
                }
              },
              "type": ["object", "null"]
            }
          }
        }
      },
      "actions": {
        "For_each": {
          "foreach": "@triggerBody()?['data']",
          "actions": {
            "Create_incident": {
              "type": "ApiConnection",
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel-webhook-1']['connectionId']"
                  }
                },
                "method": "put",
                "body": {
                  "title": "@{items('For_each')?['alarm_type_details']?['alarm_generic_title']} @{items('For_each')?['alarm_id']}",
                  "severity": "@items('For_each')?['alarm_risk_level']",
                  "status": "New",
                  "description": "@items('For_each')?['alarm_text']"
                },
                "path": "[variables('azureSentinelWorkspacePath')]"
              }
            }
          },
          "runAfter": {},
          "type": "Foreach"
        }
      },
      "outputs": {},
      "parameters": {
        "$connections": {
          "type": "Object",
          "defaultValue": {}
        }
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('azureSentinelConnectionName')]",
      "location": "[parameters('location')]",
      "kind": "V1",
      "properties": {
        "api": {
          "id": "[variables('azureSentinelConnectionResourceId')]"
        },
        "displayName": "AzureSentinel",
        "parameterValues": {
          "token": {
            "value": ""
          }
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('logicAppName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('azureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": "[variables('workflowDefinition')]",
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel-webhook-1": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('azureSentinelConnectionName'))]",
                "connectionName": "[variables('azureSentinelConnectionName')]",
                "id": "[variables('azureSentinelConnectionResourceId')]"
              }
            }
          }
        }
      }
    }
  ]
}
