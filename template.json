{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "logicAppName": {
      "type": "string",
      "defaultValue": "SOCRadar-Sentinel-Webhook-LA",
      "metadata": {
        "description": "The name of the Logic App to create."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The location for the Logic App and API connections."
      }
    },
    "azureSentinelConnectionName": {
      "type": "string",
      "defaultValue": "azuresentinel-webhook-1",
      "metadata": {
        "description": "The name for the Azure Sentinel API connection."
      }
    },
    "azureSentinelConnectionResourceId": {
      "type": "string",
      "defaultValue": "/subscriptions/6fc315b1-e624-4ca1-9d8c-288b264ae0a9/providers/Microsoft.Web/locations/northeurope/managedApis/azuresentinel",
      "metadata": {
        "description": "The resource ID of the Azure Sentinel managed API. Update the location if needed."
      }
    },
    "azureSentinelWorkspacePath": {
      "type": "string",
      "defaultValue": "/Incidents/subscriptions/6fc315b1-e624-4ca1-9d8c-288b264ae0a9/resourceGroups/resourceapps/workspaces/sentinelworkspace",
      "metadata": {
        "description": "The path to the Sentinel Workspace where incidents will be created. IMPORTANT: Update this value."
      }
    }
  },
  "variables": {
    "workflowDefinition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "triggers": {
        "manual": {
          "type": "Http",
          "kind": "Http",
          "inputs": {
            "schema": {
              "properties": {
                "data": {
                  "items": {
                    "properties": {
                      "alarm_asset": {
                        "type": ["string", "null"]
                      },
                      "alarm_assignees": {
                        "type": ["array", "null"]
                      },
                      "alarm_id": {
                        "type": ["integer", "null"]
                      },
                      "alarm_related_assets": {
                        "type": ["array", "null"]
                      },
                      "alarm_related_entities": {
                        "items": {
                          "properties": {
                            "key": {
                              "type": ["string", "null"]
                            },
                            "value": {
                              "type": ["string", "null"]
                            }
                          },
                          "type": ["object", "null"]
                        },
                        "type": ["array", "null"]
                      },
                      "alarm_response": {
                        "type": ["string", "null"]
                      },
                      "alarm_risk_level": {
                        "type": ["string", "null"]
                      },
                      "alarm_text": {
                        "type": ["string", "null"]
                      },
                      "alarm_type_details": {
                        "properties": {
                          "alarm_generic_title": {
                            "type": ["string", "null"]
                          }
                        },
                        "type": ["object", "null"]
                      },
                      "approved_by": {
                        "type": ["object", "string", "null"]
                      },
                      "content": {
                        "type": ["object", "null"]
                      },
                      "date": {
                        "type": ["string", "null"]
                      },
                      "extra": {
                        "type": ["array", "null"]
                      },
                      "history": {
                        "type": ["array", "null"]
                      },
                      "is_approved": {
                        "type": ["boolean", "null"]
                      },
                      "last_notification_date": {
                        "type": ["string", "null"]
                      },
                      "notes": {
                        "type": ["array", "null"]
                      },
                      "notification_id": {
                        "type": ["integer", "null"]
                      },
                      "status": {
                        "type": ["string", "null"]
                      },
                      "tags": {
                        "type": ["array", "null"]
                      }
                    },
                    "type": ["object", "null"]
                  },
                  "type": ["array", "null"]
                },
                "is_success": {
                  "type": ["boolean", "null"]
                },
                "message": {
                  "type": ["string", "null"]
                },
                "response_code": {
                  "type": ["integer", "null"]
                }
              },
              "type": ["object", "null"]
            }
          }
        }
      },
      "actions": {
        "For_each": {
          "foreach": "@triggerBody()?['data']",
          "actions": {
            "Create_incident": {
              "type": "ApiConnection",
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel-webhook-1']['connectionId']"
                  }
                },
                "method": "put",
                "body": {
                  "title": "@{items('For_each')?['alarm_type_details']?['alarm_generic_title']} @{items('For_each')?['alarm_id']}",
                  "severity": "@items('For_each')?['alarm_risk_level']",
                  "status": "New",
                  "description": "@items('For_each')?['alarm_text']"
                },
                "path": "[parameters('azureSentinelWorkspacePath')]"
              }
            }
          },
          "runAfter": {},
          "type": "Foreach"
        }
      },
      "outputs": {},
      "parameters": {
        "$connections": {
          "type": "Object",
          "defaultValue": {}
        }
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[parameters('azureSentinelConnectionName')]",
      "location": "[parameters('location')]",
      "kind": "V1",
      "properties": {
        "api": {
          "id": "[parameters('azureSentinelConnectionResourceId')]"
        },
        "displayName": "AzureSentinel",
        "parameterValues": {
          "token": {
            "value": ""
          }
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('logicAppName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', parameters('azureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": "[variables('workflowDefinition')]",
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel-webhook-1": {
                "connectionId": "[resourceId('Microsoft.Web/connections', parameters('azureSentinelConnectionName'))]",
                "connectionName": "[parameters('azureSentinelConnectionName')]",
                "id": "[parameters('azureSentinelConnectionResourceId')]"
              }
            }
          }
        }
      }
    }
  ]
}
