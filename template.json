{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "logicAppName": {
      "type": "string",
      "defaultValue": "SOCRadar-Sentinel-Webhook-LA",
      "metadata": {
        "description": "The name of the Logic App to create."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The location for the Logic App and API connections."
      }
    },
    "sentinelWorkspaceName": {
      "type": "string",
      "metadata": {
        "description": "Name of your Microsoft Sentinel workspace"
      }
    },
    "sentinelResourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "Resource group name containing the Sentinel workspace"
      }
    },
    "sentinelSubscriptionId": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "Subscription ID containing the Sentinel workspace"
      }
    }
  },
  "variables": {
    "azureSentinelConnectionName": "azuresentinel-webhook-connection",
    "azureSentinelConnectionResourceId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('location'), '/managedApis/azuresentinel')]",
    "azureSentinelWorkspacePath": "[concat('/Incidents/subscriptions/', parameters('sentinelSubscriptionId'), '/resourceGroups/', parameters('sentinelResourceGroupName'), '/workspaces/', parameters('sentinelWorkspaceName'))]",
    "workflowDefinition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "triggers": {
        "manual": {
          "type": "Request",
          "kind": "Http",
          "inputs": {
            "method": "POST",
            "schema": {
              "type": "object",
              "properties": {
                "data": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "alarm_asset": {
                        "type": "string"
                      },
                      "alarm_assignees": {
                        "type": "array"
                      },
                      "alarm_id": {
                        "type": "integer"
                      },
                      "alarm_related_assets": {
                        "type": "array"
                      },
                      "alarm_related_entities": {
                        "type": "array",
                        "items": {
                          "type": "object",
                          "properties": {
                            "key": {
                              "type": "string"
                            },
                            "value": {
                              "type": "string"
                            }
                          }
                        }
                      },
                      "alarm_response": {
                        "type": "string"
                      },
                      "alarm_risk_level": {
                        "type": "string"
                      },
                      "alarm_text": {
                        "type": "string"
                      },
                      "alarm_type_details": {
                        "type": "object",
                        "properties": {
                          "alarm_generic_title": {
                            "type": "string"
                          }
                        }
                      },
                      "approved_by": {
                        "type": "object"
                      },
                      "content": {
                        "type": "object"
                      },
                      "date": {
                        "type": "string"
                      },
                      "extra": {
                        "type": "array"
                      },
                      "history": {
                        "type": "array"
                      },
                      "is_approved": {
                        "type": "boolean"
                      },
                      "last_notification_date": {
                        "type": "string"
                      },
                      "notes": {
                        "type": "array"
                      },
                      "notification_id": {
                        "type": "integer"
                      },
                      "status": {
                        "type": "string"
                      },
                      "tags": {
                        "type": "array"
                      }
                    }
                  }
                },
                "is_success": {
                  "type": "boolean"
                },
                "message": {
                  "type": "string"
                },
                "response_code": {
                  "type": "integer"
                }
              }
            }
          }
        }
      },
      "actions": {
        "For_each": {
          "foreach": "@triggerBody()?['data']",
          "actions": {
            "Create_incident": {
              "type": "ApiConnection",
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "put",
                "body": {
                  "title": "@{if(empty(items('For_each')?['alarm_type_details']?['alarm_generic_title']), 'SOCRadar Alert', items('For_each')?['alarm_type_details']?['alarm_generic_title'])} - ID: @{items('For_each')?['alarm_id']}",
                  "severity": "@{if(empty(items('For_each')?['alarm_risk_level']), 'Medium', items('For_each')?['alarm_risk_level'])}",
                  "status": "New",
                  "description": "@{if(empty(items('For_each')?['alarm_text']), 'No description available', items('For_each')?['alarm_text'])}"
                },
                "path": "[variables('azureSentinelWorkspacePath')]"
              }
            }
          },
          "runAfter": {},
          "type": "Foreach"
        },
        "Response": {
          "runAfter": {
            "For_each": ["Succeeded"]
          },
          "type": "Response",
          "kind": "Http",
          "inputs": {
            "statusCode": 200,
            "body": {
              "message": "Incidents created successfully",
              "processedCount": "@length(triggerBody()?['data'])"
            }
          }
        }
      },
      "outputs": {},
      "parameters": {
        "$connections": {
          "type": "Object",
          "defaultValue": {}
        }
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('azureSentinelConnectionName')]",
      "location": "[parameters('location')]",
      "kind": "V1",
      "properties": {
        "api": {
          "id": "[variables('azureSentinelConnectionResourceId')]"
        },
        "displayName": "Azure Sentinel Connection",
        "customParameterValues": {}
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('logicAppName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('azureSentinelConnectionName'))]"
      ],
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "state": "Enabled",
        "definition": "[variables('workflowDefinition')]",
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('azureSentinelConnectionName'))]",
                "connectionName": "[variables('azureSentinelConnectionName')]",
                "id": "[variables('azureSentinelConnectionResourceId')]"
              }
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "logicAppUrl": {
      "type": "string",
      "value": "[concat('https://portal.azure.com/#resource', resourceId('Microsoft.Logic/workflows', parameters('logicAppName')))]"
    },
    "webhookUrl": {
      "type": "string",
      "value": "[listCallbackUrl(concat(resourceId('Microsoft.Logic/workflows', parameters('logicAppName')), '/triggers/manual'), '2017-07-01').value]"
    },
    "connectionToAuthorize": {
      "type": "string",
      "value": "[concat('https://portal.azure.com/#resource', resourceId('Microsoft.Web/connections', variables('azureSentinelConnectionName')), '/edit')]"
    }
  }
}
